import os
import shutil

def find_video_file(folder_name, downloads_path):
    """
    Find a video file in downloads directory that matches the folder name
    (without the .gifs extension)
    """
    # Remove the .gifs extension from folder name
    base_name = folder_name.replace('.gifs', '')
    
    # Common video file extensions
    video_extensions = ['.mp4', '.avi', '.mkv', '.mov', '.wmv', '.flv', 
                       '.webm', '.m4v', '.3gp', '.mpeg', '.mpg', '.ts',
                       '.mts', '.m2ts', '.vob', '.ogv', '.divx', '.xvid']
    
    # Search for files with the base name and any video extension
    for filename in os.listdir(downloads_path):
        name, ext = os.path.splitext(filename)
        if name == base_name and ext.lower() in video_extensions:
            return os.path.join(downloads_path, filename)
    
    return None

def cleanup_gifs_folders_and_videos():
    target_directory = r"C:\Users\harip\ALL TEST"
    downloads_directory = r"D:\downloads"
    
    if not os.path.exists(target_directory):
        print(f"‚ùå Directory not found: {target_directory}")
        return 0, 0
    
    if not os.path.exists(downloads_directory):
        print(f"‚ùå Downloads directory not found: {downloads_directory}")
        return 0, 0
    
    try:
        # Get all items in the directory
        all_items = os.listdir(target_directory)
        
        # Filter only folders that end with .gifs
        gifs_folders = []
        for item in all_items:
            item_path = os.path.join(target_directory, item)
            if os.path.isdir(item_path) and item.endswith('.gifs'):
                gifs_folders.append(item)
        
        # Find pairs where both .gifs folder AND corresponding video file exist
        deletion_pairs = []
        for folder in gifs_folders:
            video_file = find_video_file(folder, downloads_directory)
            if video_file and os.path.exists(video_file):
                deletion_pairs.append({
                    'folder': folder,
                    'folder_path': os.path.join(target_directory, folder),
                    'video_file': video_file,
                    'video_name': os.path.basename(video_file)
                })
        
        # Count results
        pair_count = len(deletion_pairs)
        
        if pair_count == 0:
            print("‚úÖ No matching .gifs folder + video file pairs found to delete.")
            print("‚ÑπÔ∏è  Only deleting when BOTH .gifs folder AND video file exist.")
            return 0, 0
        
        print(f"üìÅ Found {pair_count} .gifs folder + video file pair(s) (BOTH exist):")
        for i, pair in enumerate(deletion_pairs, 1):
            print(f"  {i}. {pair['folder']} + {pair['video_name']}")
        
        # Ask for confirmation before deletion
        print(f"\n‚ö†Ô∏è  WARNING: This will permanently delete {pair_count} pairs:")
        print(f"   - .gifs folders from {target_directory}")
        print(f"   - Corresponding video files from {downloads_directory}")
        print("   This action cannot be undone!")
        
        confirmation = input("\nType 'YES' to confirm deletion, or anything else to cancel: ").strip()
        
        if confirmation.upper() == 'YES':
            deleted_folder_count = 0
            deleted_video_count = 0
            
            # Delete both folders and videos
            for pair in deletion_pairs:
                # Delete .gifs folder
                try:
                    shutil.rmtree(pair['folder_path'])
                    print(f"‚úÖ Deleted folder: {pair['folder']}")
                    deleted_folder_count += 1
                except Exception as e:
                    print(f"‚ùå Failed to delete folder {pair['folder']}: {e}")
                    continue  # Skip video deletion if folder deletion failed
                
                # Delete video file
                try:
                    os.remove(pair['video_file'])
                    print(f"‚úÖ Deleted video: {pair['video_name']}")
                    deleted_video_count += 1
                except Exception as e:
                    print(f"‚ùå Failed to delete video {pair['video_name']}: {e}")
            
            print(f"\nüéâ Cleanup completed!")
            print(f"   - Deleted {deleted_folder_count} .gifs folder(s)")
            print(f"   - Deleted {deleted_video_count} video file(s)")
            
            return deleted_folder_count, deleted_video_count
        else:
            print("‚ùå Deletion cancelled by user.")
            return 0, 0
            
    except Exception as e:
        print(f"‚ùå Error during cleanup: {e}")
        return 0, 0

# --- Additional function to show what WOULD be deleted ---
def preview_cleanup():
    """
    Preview what would be deleted without actually deleting anything
    """
    target_directory = r"C:\Users\harip\ALL TEST"
    downloads_directory = r"D:\downloads"
    
    print("\nüîç PREVIEW MODE (No files will be deleted)")
    print("=" * 50)
    
    if not os.path.exists(target_directory):
        print(f"‚ùå Directory not found: {target_directory}")
        return
    
    if not os.path.exists(downloads_directory):
        print(f"‚ùå Downloads directory not found: {downloads_directory}")
        return
    
    try:
        # Get all items in the directory
        all_items = os.listdir(target_directory)
        
        # Filter only folders that end with .gifs
        gifs_folders = []
        for item in all_items:
            item_path = os.path.join(target_directory, item)
            if os.path.isdir(item_path) and item.endswith('.gifs'):
                gifs_folders.append(item)
        
        # Find pairs where both exist
        deletion_pairs = []
        folders_without_videos = []
        videos_without_folders = []
        
        for folder in gifs_folders:
            video_file = find_video_file(folder, downloads_directory)
            if video_file and os.path.exists(video_file):
                deletion_pairs.append({
                    'folder': folder,
                    'video_name': os.path.basename(video_file)
                })
            else:
                folders_without_videos.append(folder)
        
        # Also find videos that don't have corresponding .gifs folders
        for filename in os.listdir(downloads_directory):
            name, ext = os.path.splitext(filename)
            video_extensions = ['.mp4', '.avi', '.mkv', '.mov', '.wmv', '.flv', '.webm']
            if ext.lower() in video_extensions:
                corresponding_folder = name + '.gifs'
                if not os.path.exists(os.path.join(target_directory, corresponding_folder)):
                    videos_without_folders.append(filename)
        
        # Display results
        if deletion_pairs:
            print(f"\nüéØ WOULD BE DELETED ({len(deletion_pairs)} pairs - BOTH exist):")
            for i, pair in enumerate(deletion_pairs, 1):
                print(f"  {i}. {pair['folder']} + {pair['video_name']}")
        else:
            print(f"\n‚úÖ No .gifs folder + video file pairs found (nothing would be deleted)")
        
        if folders_without_videos:
            print(f"\nüìÅ FOLDERS WITHOUT VIDEOS ({len(folders_without_videos)} - would NOT be deleted):")
            for i, folder in enumerate(folders_without_videos, 1):
                print(f"  {i}. {folder} (no matching video file)")
        
        if videos_without_folders:
            print(f"\nüé¨ VIDEOS WITHOUT FOLDERS ({len(videos_without_folders)} - would NOT be deleted):")
            for i, video in enumerate(videos_without_folders, 1):
                print(f"  {i}. {video} (no matching .gifs folder)")
        
        print(f"\nüí° Only pairs where BOTH .gifs folder AND video file exist will be deleted!")
        
    except Exception as e:
        print(f"‚ùå Error during preview: {e}")

# --- Main Program Execution ---
if __name__ == "__main__":
    
    print("üßπ .GIFS FOLDER & VIDEO CLEANUP TOOL")
    print("=" * 50)
    print("üí° Only deletes when BOTH .gifs folder AND video file exist!")
    
    # Ask if user wants to preview first
    preview = input("\nüîç Do you want to preview what would be deleted first? (y/n): ").strip().lower()
    if preview == 'y' or preview == 'yes':
        preview_cleanup()
        print("\n" + "="*50)
    
    # Run the cleanup function
    deleted_folders, deleted_videos = cleanup_gifs_folders_and_videos()
    
    print(f"\n{'='*50}")
    print("üìä CLEANUP SUMMARY")
    print(f"{'='*50}")
    print(f"üóëÔ∏è  Folders deleted: {deleted_folders}")
    print(f"üé¨ Videos deleted: {deleted_videos}")
    print("üéâ Operation completed!")
